var pwlog=void 0,pwerror=void 0;function isStringEmpty(e){return!e||0===e.length}function humanReadableFormType(e){switch(e){case WBSAutoFillFormTypeUndetermined:return"Undetermined";case WBSAutoFillFormTypeAutoFillableStandard:return"AutoFillable:Standard";case WBSAutoFillFormTypeNonAutoFillable:return"NonAutoFillable";case WBSAutoFillFormTypeAutoFillableLogin:return"AutoFillable:Login";case WBSAutoFillFormTypeNewAccount:return"NewAccount";case WBSAutoFillFormTypeChangePassword:return"ChangePassword";case WBSAutoFillFormTypeFoundTOTPURI:return"FoundTOTPUri"}return"Unrecognized"}function domainsForDisplayFromUsernamesAndDomains(e,t){const s=e.length;let o=t.map((function(e){return e.replace(/^(www|m)\./,"")})),a=[];for(var n=0;n<s;n++)a.push([e[n],o[n]]);for(n=0;n<s;n++){let e=[];for(var r=n+1;r<s;r++)a[n].join("\n")===a[r].join("\n")&&(e.length||e.push(n),e.push(r));for(identicalIndex of e)o[identicalIndex]=t[identicalIndex]}return o}function urlIsBrowserURL(e){const t=e.protocol;return"chrome:"===t||"edge:"===t||"about:"==t}function capabilitiesDeclaresMacOS(e){try{return"macos"===e.operatingSystem.name}catch{return!1}}class Localizer{static configureDocumentElementForLanguage(e,t){switch(t){case"he":case"ar":case"fa":e.setAttribute("dir","rtl"),e.setAttribute("lang",t)}}#e={};constructor(e){e&&(this.#e=e.operatingSystem)}getMessage(e,t,s){const o=this.messageNamesToTry(e);for(let e of o){let o;try{o=chrome.i18n.getMessage(e,t,s)}catch{o=chrome.i18n.getMessage(e,t)}if(o)return o}return""}messageNamesToTry(e){let t=[];const s=this.#e,o=s?s.name:void 0,a=s?s.majorVersion:void 0,n=s?s.minorVersion:void 0,r=void 0!==a;return o&&r&&void 0!==n&&t.push(`${e}_${o}_${a}_${n}`),o&&r&&t.push(`${e}_${o}_${a}`),o?t.push(`${e}_${o}`):t.push(`${e}_${this.#t}`),t.push(e),t}get#t(){return navigator.platform.startsWith("Mac")?"macos":"windows"}}class ExtensionSettings{#s=!1;#o=!0;#a=!0;eventTarget=new EventTarget;constructor(e=!1){this.#s=e,this.#n(),this.#r()}get enableInPageAutoFill(){return this.#o}set enableInPageAutoFill(e){this.#o=e,this.#i()}get allowExtensionToControlAutoFillSettings(){return this.#a}set allowExtensionToControlAutoFillSettings(e){this.#a=e,this.#c().then(this.#i.bind(this))}#c(){return this.#a?this.attemptToControlBrowserAutoFillSettings():this.clearControlOfBrowserAutoFillSettings()}attemptToControlBrowserAutoFillSettings(){return this.#s?Promise.reject(new Error("This Settings instance does not allow writing browser settings")):Promise.allSettled([null,null,null]).then((e=>(this.#d(),e)))}clearControlOfBrowserAutoFillSettings(){return this.#s?Promise.reject(new Error("This Settings instance does not allow writing browser settings")):Promise.allSettled([this.#g(chrome.privacy.services.passwordSavingEnabled),this.#g(chrome.privacy.services.autofillCreditCardEnabled),this.#g(chrome.privacy.services.autofillAddressEnabled)]).then((e=>(this.#d(),e)))}#n(){let e=new Promise((e=>{chrome.storage.sync.get({enableInPageAutoFill:!0,allowExtensionToControlAutoFillSettings:!0},(t=>{this.#o=t.enableInPageAutoFill,this.#a=t.allowExtensionToControlAutoFillSettings,e()}))}));return this.#s||(e=e.then(this.#c.bind(this))),e.then(this.#d.bind(this))}#i(){return new Promise((e=>{chrome.storage.sync.set({enableInPageAutoFill:this.#o,allowExtensionToControlAutoFillSettings:this.#a},(()=>{e()}))})).then(this.#d.bind(this))}#r(){this.#s||(chrome.privacy.services.passwordSavingEnabled&&chrome.privacy.services.passwordSavingEnabled.onChange.addListener((e=>{this.#d()})),chrome.privacy.services.autofillCreditCardEnabled&&chrome.privacy.services.autofillCreditCardEnabled.onChange.addListener((e=>{this.#d()})),chrome.privacy.services.autofillAddressEnabled&&chrome.privacy.services.autofillAddressEnabled.onChange.addListener((e=>{this.#d()})))}#d(){const e=new CustomEvent("settingsChanged",{detail:{enableInPageAutoFill:this.#o}});this.eventTarget.dispatchEvent(e)}#l(e,t){return this.#m(e).then((s=>s?s.value===t?{details:s,newValue:t}:new Promise(((o,a)=>{e.set({value:t},(()=>{chrome.runtime.lastError&&(chrome.runtime.lastError,chrome.runtime.lastError,a(chrome.runtime.lastError)),o({details:s,newValue:t})}))})):{details:{},newValue:void 0})).catch((e=>{}))}#m(e){return new Promise((t=>{e||t({}),e.get({},(e=>{"not_controllable"===e.levelOfControl&&reject(new Error("Cannot control this setting")),t(e)}))}))}#g(e){return new Promise((t=>{e||t(),e.clear({},(()=>{t()}))}))}}const ErrCodes={ErrSuccess:"Success",InvalidMessage:"InvalidMessage",UnexpectedMessage:"UnexpectedMessage",InvalidSyntax:"InvalidSyntax",InvalidSessionKey:"InvalidSessionKey",CryptoError:"CryptoError",InvalidUserName:"InvalidUserName"};class SecretSessionError extends Error{constructor(e,t=null){super(t),this.code=e}}const SecretSessionVersion={SRPWithOldVerification:0,SRPWithRFCVerification:1},scriptVersion="1.0",appVersion="1.0",MSGTypes={MSG0:0,MSG1:1,MSG2:2,MSG3:3};SecretSession=function(e){this.shouldUseBase64=!1,e.shouldUseBase64&&(this.shouldUseBase64=e.shouldUseBase64),this.protocolVersion=SecretSessionVersion.SRPWithOldVerification,e.secretSessionVersion&&(this.protocolVersion=e.secretSessionVersion),this.grp=sjcl.keyexchange.srp.knownGroup(3072),this.keyLen=128,this.tagLen=128,this.setUpSRP()},SecretSession.prototype={createSMSG:function(e){if("object"==typeof e)try{e=JSON.stringify(e)}catch(e){return ErrCodes.InvalidMessage}const t=sjcl.codec.utf8String.toBits(e),s=this.encrypt(t);if("string"==typeof s)return s;let o=null;try{o=JSON.stringify({TID:this.bitsToString(this.I.toBits()),SDATA:this.bitsToString(s,!1)})}catch(e){return ErrCodes.InvalidMessage}return o},parseSMSG:function(e){let t=e;if("string"==typeof t)try{t=JSON.parse(e)}catch(t){throw new SecretSessionError(ErrCodes.InvalidSyntax,`Unable to decode SMSG from string: ${t} ${e}`)}if("string"!=typeof t.SDATA)throw new SecretSessionError(ErrCodes.InvalidMessage,"Missing or invalid SDATA field in SMSG message.");if("string"!=typeof t.TID)throw new SecretSessionError(ErrCodes.InvalidUserName,"Missing or invalid 'TID' field in SMSG object.");const s=sjcl.bn.fromBits(this.stringToBits(t.TID));if(!this.I.equals(s))throw new SecretSessionError(ErrCodes.InvalidUserName,"Received SMSG message meant for another session.");return sjcl.codec.utf8String.fromBits(this.decrypt(this.stringToBits(t.SDATA)))},setPin:function(e){this.P=e},stringToBase64:function(e){let t=sjcl.codec.utf8String.toBits(e);return sjcl.codec.base64.fromBits(t,!1,!1)},bitsToString:function(e,t=!0){return this.shouldUseBase64?sjcl.codec.base64.fromBits(e):(t?"0x":"")+sjcl.codec.hex.fromBits(e)},stringToBits:function(e){return this.shouldUseBase64?sjcl.codec.base64.toBits(e):sjcl.codec.hex.toBits(e)},setUpSRP:function(){this.I=sjcl.bn.fromBits(this._randomWords(4)),this.a=sjcl.bn.fromBits(this._randomWords(8)),this.A=this.grp.g.powermod(this.a,this.grp.N)},currProtocols:function(){return[SecretSessionVersion.SRPWithOldVerification,SecretSessionVersion.SRPWithRFCVerification]},initialMessage:function(){this.expectedMessage=MSGTypes.MSG1;let e=null;try{e=JSON.stringify({TID:this.bitsToString(this.I.toBits()),MSG:0,A:this.bitsToString(this.A.toBits()),VER:"1.0",PROTO:this.currProtocols()})}catch(e){return null}return this.stringToBase64(e)},_padToModulusLength:function(e){e=e.replace(/^0x/,"");const t=2*(sjcl.bitArray.bitLength(this.grp.N.toBits())+7>>3)-e.length;if(0===t)return e;return"0".repeat(t)+e},processMessage:function(e){const t=sjcl.codec.utf8String.fromBits(sjcl.codec.base64.toBits(e));let s=null;try{s=JSON.parse(t)}catch(e){throw new SecretSessionError(ErrCodes.InvalidMessage,`Unable to parse JSON message: ${e}`)}if("string"!=typeof s.TID)throw new SecretSessionError(ErrCodes.InvalidMessage,"Missing or invalid 'TID' field in PAKE message.");let o=sjcl.bn.fromBits(this.stringToBits(s.TID));if(!this.I.equals(o))throw new SecretSessionError(ErrCodes.UnexpectedMessage,"Unexpected message");if(!s.MSG)throw new SecretSessionError(ErrCodes.InvalidMessage,"Missing 'MSG' field in PAKE message.");const a=parseInt(s.MSG,10);if(this.expectedMessage!==a)throw new SecretSessionError(ErrCodes.UnexpectedMessage,`Received Message ${message.MSG}, but expected Message ${this.expectedMessage} `);let n=null;if(a===MSGTypes.MSG1){var r=SecretSessionVersion.SRPWithOldVerification;"number"==typeof s.PROTO&&(r=s.PROTO,Object.values(SecretSessionVersion).includes(r)||(r=SecretSessionVersion.SRPWithOldVerification)),this.protocolVersion=r,n=this.processMessage1(s)}else a===MSGTypes.MSG3&&(n=this.processMessage3(s));return n},createSessionKey:function(e,t){const s=sjcl.hash.sha256.hash,o=this._calculateX(e,this.bitsToString(this.I.toBits()),this.P,s);this.v=this._calculateVerifier(this.grp.g,o,this.grp.N);const a=this.A.toString(),n=t.toString(),r=this._padToModulusLength(a).concat(this._padToModulusLength(n)),i=sjcl.bn.fromBits(s(sjcl.codec.hex.toBits(r))),c=this.a.add(i.mul(o)),l=this.grp.N.toString()+this._padToModulusLength(this.grp.g.toString()),d=sjcl.bn.fromBits(s(sjcl.codec.hex.toBits(l))).mulmod(this.v,this.grp.N);return s(t.sub(d).powermod(c,this.grp.N).toBits())},_calculateX:function(e,t,s,o){const a=o(t+":"+s);return sjcl.bn.fromBits(o(e.concat(a)))},_calculateVerifier:function(e,t,s){return e.powermod(t,s)},_calculateM:function(e,t,s){const o=sjcl.hash.sha256.hash;let a=o(this.grp.N.toBits()),n=o(sjcl.codec.hex.toBits(this._padToModulusLength(this.grp.g.toString())));const r=sjcl.bitArray.bitLength(a)/32;for(let e=0;e<r;++e)a[e]=a[e]^n[e];let i=o(this.bitsToString(this.I.toBits())),c=new sjcl.hash.sha256;c.update(a),c.update(i),c.update(e),c.update(this.A.toBits()),c.update(t.toBits()),c.update(s);let l=c.finalize();return c=new sjcl.hash.sha256,c.update(this.A.toBits()),c.update(l),c.update(s),this.hamk=c.finalize(),l},processMessage1:function(e){if("string"!=typeof e.s||"string"!=typeof e.B)throw new SecretSessionError(ErrCodes.InvalidMessage,"Message 1 is missing some required keys.");e.VER&&(this.appVer=e.VER);const t=this.stringToBits(e.s),s=sjcl.bn.fromBits(this.stringToBits(e.B));let o=new sjcl.bn(1);if(0==s.mulmod(o,this.grp.N))throw new SecretSessionError(ErrCodes.CryptoError,"B.mulmod error");const a=this.createSessionKey(t,s);this.encKey=sjcl.bitArray.bitSlice(a,0,this.keyLen),this.expectedMessage=MSGTypes.MSG3;let n={TID:this.bitsToString(this.I.toBits()),MSG:2};switch(this.protocolVersion){case SecretSessionVersion.SRPWithRFCVerification:n.M=this.bitsToString(this._calculateM(t,s,a),!1);break;case SecretSessionVersion.SRPWithOldVerification:const e=this.shouldUseBase64?this.v.toBits():sjcl.codec.utf8String.toBits(this.v.toString()),o=this.encrypt(e);n.v=this.bitsToString(o,!1);break;default:throw new SecretSessionError(ErrCodes.UnexpectedMessage,`Unknown protocol version ${this.protocolVersion}`)}let r=null;try{r=JSON.stringify(n)}catch(e){throw new SecretSessionError(ErrCodes.InvalidMessage,`Error encoding Message 2 to string:${e}`)}return this.stringToBase64(r)},processMessage3:function(e){let t=ErrCodes.ErrSuccess,s="";if(0!==e.ErrCode)s=`Message 3 contained an error: ${e.ErrCode}`,t=ErrCodes.InvalidMessage;else switch(this.protocolVersion){case SecretSessionVersion.SRPWithRFCVerification:if(e.HAMK){const o=this.stringToBits(e.HAMK);sjcl.bitArray.equal(o,this.hamk)||(s="Failed to verify server data.",this.msgExp=MSGTypes.MSG1,t=ErrCodes.InvalidSessionKey)}else s=`Message 3 does not contain necessary data:${e.ErrCode}`,t=ErrCodes.InvalidMessage;break;case SecretSessionVersion.SRPWithOldVerification:break;default:t=ErrCode.UnexpectedMessage,s=`Unknown SecretSessionVersion ${this.protocolVersion}.`}if(t!=ErrCodes.ErrSuccess)throw this.sessionKey=null,this.expectedMessage=MSGTypes.MSG1,new SecretSessionError(t,s);return t===ErrCodes.ErrSuccess},encrypt:function(e){if(!this.encKey)throw new SecretSessionError(ErrCodes.InvalidSessionKey,"Called encrypt() without a session key");const t=new sjcl.cipher.aes(this.encKey),s=this._randomWords(4);let o=null;try{o=sjcl.mode.gcm.encrypt(t,e,s)}catch(e){throw new SecretSessionError(ErrCodes.CryptoError,e.message)}return sjcl.bitArray.concat(o,s)},decrypt:function(e){if(!this.encKey)throw new SecretSessionError(ErrCodes.InvalidSessionKey,"Called decrypt() without a session key!");const t=new sjcl.cipher.aes(this.encKey),s=sjcl.bitArray.bitSlice(e,0,this.keyLen),o=sjcl.bitArray.bitSlice(e,this.keyLen);let a=null;try{a=sjcl.mode.gcm.decrypt(t,o,s)}catch(e){throw new SecretSessionError(ErrCodes.CryptoError,`Exception while decrypting message. ${e}`)}return a},_randomWords:function(e){const t=new Int32Array(e);return self.crypto.getRandomValues(t),Array.from(t)}};const ContextState={IncompatibleOS:"IncompatibleOS",NotInSession:"NotInSession",NativeSupportNotInstalled:"NativeSupportNotInstalled",CheckEngine:"CheckEngine",ChallengeSent:"ChallengeSent",MSG1Set:"MSG1Set",SessionKeySet:"SessionKeySet"},DataState={Initial:"Initial",Frame0Processed:"Frame0Processed",DataProcessed:"DataProcessed"},RememberIC={NoValueSet:"NoValueSet",UnknownPage:"UnknownPage",DoNotRemember:"DoNotRemember",RememberLoginAndPassword:"RememberLoginAndPassword"},WBSAutoFillFormTypeUndetermined=0,WBSAutoFillFormTypeAutoFillableStandard=1,WBSAutoFillFormTypeNonAutoFillable=2,WBSAutoFillFormTypeAutoFillableLogin=3,WBSAutoFillFormTypeNewAccount=4,WBSAutoFillFormTypeChangePassword=5,WBSAutoFillFormTypeFoundTOTPURI=6;importScripts("/sjcl.js");const CmdEndOp=0,CmdUnused1=1,CmdChallengePIN=2,CmdSetIconNTitle=3,CmdGetLoginNames4URL=4,CmdGetPassword4LoginName=5,CmdSetPassword4LoginName_URL=6,CmdNewAccount4URL=7,CmdTabEvent=8,CmdPasswordsDisabled=9,CmdReloginNeeded=10,CmdLaunchiCP=11,CmdiCPStateChange=12,CmdLaunchPasswordsApp=13,CmdHello=14,CmdOneTimeCodeAvailable=15,CmdGetOneTimeCodes=16,CmdDidFillOneTimeCode=17,CmdSetUpTOTPGenerator=18,CmdOpenURLInSafari=1984,QueryStatus={Success:0,NoResults:3};function cmd2string(e){switch(e){case 0:return"CmdEndOp";case 1:return"CmdUnused1";case 2:return"CmdChallengePIN";case 3:return"CmdSetIconNTitle";case 4:return"CmdGetLoginNames4URL";case 5:return"CmdGetPassword4LoginName";case 6:return"CmdSetPassword4LoginName_URL";case 7:return"CmdNewAccount4URL";case 8:return"CmdTabEvent";case 9:return"CmdPasswordsDisabled";case 10:return"CmdReloginNeeded";case 11:return"CmdLaunchiCP";case 12:return"CmdiCPStateChange";case 13:return"CmdLaunchPasswordsApp";case 14:return"CmdHello";case 15:return"CmdOneTimeCodeAvailable";case 16:return"CmdGetOneTimeCodes";case 17:return"CmdDidFillOneTimeCode";case 1984:return"CmdOpenURLInSafari";default:return"Unknown Command"}}var actUnknown=-1,actDelete=0,actUpdate=1,actSearch=2,actAddNew=3,actMaybeAdd=4,actGhostSearch=5;const DefaultCapabilities={shouldUseBase64:!1,secretSessionVersion:SecretSessionVersion.SRPWithOldVerification,canFillOneTimeCodes:!1,operatingSystem:{},supportsSubURLs:!1,scanForOTPURI:!1},AmountOfTimeToBlockRefreshForNativeAppDisconnection=5e3;var g_lastToolbarIconImageName,g_timeStartedFetchingCredentials,g_nativeAppPort=null,g_portToCompletionList=null,g_portToPopup=null,thePAKE=null,g_theState=ContextState.NotInSession,g_tabIdToURL=new Map,g_Stage1Logins=new Map,g_TabsToStateMap=new Map,g_ErrorReturned=!1,g_secretSession=null,g_nativeAppCapabilities=null,g_localizer=new Localizer,g_extensionSettings=new ExtensionSettings,g_urlToDownloadNativeSupport="https://support.apple.com/kb/DL1455",g_isDark=!1;function setIsDark(e){g_isDark!==e&&(g_isDark=e,chrome.storage.local.set({isDark:e}))}function imageDataForName(e){if(e)return{16:"images/"+(g_lastToolbarIconImageName=e)+(g_isDark?"-darkmode":"")+"_icon16.png",32:"images/"+g_lastToolbarIconImageName+(g_isDark?"-darkmode":"")+"_icon32.png"}}function setUpEventListners(){chrome.runtime.onInstalled&&chrome.runtime.onInstalled.addListener((e=>{chrome.declarativeContent&&chrome.declarativeContent.onPageChanged.removeRules(void 0,(function(){chrome.declarativeContent.onPageChanged.addRules([{conditions:[new chrome.declarativeContent.PageStateMatcher({pageUrl:{schemes:["https","http"]}})],actions:[new chrome.declarativeContent.ShowPageAction]}])})),"install"===e.reason&&g_extensionSettings.attemptToControlBrowserAutoFillSettings().then((e=>{})).catch((e=>{}))})),chrome.runtime.onSuspend&&chrome.runtime.onSuspend.addListener((function(){g_tabIdToURL.clear(),g_Stage1Logins.clear(),g_TabsToStateMap.clear(),g_nativeAppPort.postMessage({cmd:0})})),chrome.runtime.onSuspendCanceled&&chrome.runtime.onSuspendCanceled.addListener((function(){})),chrome.runtime.onUpdateAvailable&&chrome.runtime.onUpdateAvailable.addListener((function(){}))}function secdSTATUS2string(e){switch(e){case 0:return"secdSTATUSsuccess";case 1:return"genericError";case 2:return"invalidParam";case 3:return"itemNotFound";case 4:return"failedToDelete";case 5:return"failedToUpdate";case 6:return"invalidMessageFormat";case 7:return"duplicateItem";case 8:return"unknownAction";case 9:return"invalidSession"}}function checkForValidOS(){if("MacIntel"===navigator.platform)return g_urlToDownloadNativeSupport="https://beta.apple.com/sp/betaprogram",!0;const e=new RegExp("\\(Windows\\s*\\w*\\s*(\\d*)\\.(\\d*)","i").exec(navigator.userAgent);return null!==e&&3===e.length&&(e[1]>=10?(g_urlToDownloadNativeSupport="ms-windows-store://pdp/?productid=9PKTQ5699M62",!0):!(e[1]<6)&&!(e[2]<1))}function setGlobalState(e,t){if(setToolbarIcon((g_theState=e)===ContextState.SessionKeySet?"PasswordsToolbar":"PasswordsToolbarUnpaired"),!t)try{g_portToPopup&&g_portToPopup.postMessage({subject:"nativeConnectionStateChanged",state:g_theState,appStoreURL:g_urlToDownloadNativeSupport})}catch(e){}}function resetTheSession(e){setGlobalState(e),g_secretSession=new SecretSession(g_nativeAppCapabilities)}function STATUSErrorReturned(e){switch(secdSTATUS2string(e),g_theState){case ContextState.IncompatibleOS:case ContextState.NativeSupportNotInstalled:case ContextState.CheckEngine:case ContextState.MSG1Set:case ContextState.ChallengeSent:break;case ContextState.SessionKeySet:g_ErrorReturned=!0,resetTheSession(ContextState.NotInSession);case ContextState.NotInSession:chrome.tabs.query({active:!0,currentWindow:!0},(function(e){setToolbarIcon("PasswordsToolbarUnpaired")}))}}function logMapElements(e,t,s){}function consultStage1Logins(e,t){return isStringEmpty(e)?g_Stage1Logins.has(t)?(LoginName=g_Stage1Logins.get(t),LoginName,g_Stage1Logins.delete(t),LoginName):"":e}function entriesFromLoginNames4URLData(e){let t=e.Entries;return t||(t=[],Object.entries(e).sort().map((([e,s])=>{e.includes("Entry_")&&t.push(s)})),t)}function setToolbarIcon(e){chrome.action&&chrome.action.setIcon({path:imageDataForName(e)})}function sendMessageToPopupAndCompletionList(e){try{g_portToPopup&&g_portToPopup.postMessage(e)}catch(e){}try{g_portToCompletionList&&g_portToCompletionList.postMessage(e)}catch(e){}}function onSetUpTOTPContextMenuClicked(e,t){if(g_theState!==ContextState.SessionKeySet)window.alert(g_localizer.getMessage("enableAutoFillPasswordsMessage"));else{const t=new URL(e.pageUrl);t.hostname,e.menuItemId,setUpTOTP(t.hostname,e.menuItemId)}}function connectToBackgroundNativeAppAndSetUpListeners(){setToolbarIcon("PasswordsToolbarUnpaired"),g_nativeAppCapabilities||(g_nativeAppCapabilities=DefaultCapabilities),g_localizer=new Localizer(g_nativeAppCapabilities),g_secretSession=new SecretSession(g_nativeAppCapabilities),chrome.runtime.onMessage.addListener(((e,t,s)=>{const o=new URL(t.url);if(o.hostname,t.tab.id,t.frameId,e.from,"content"===e.from)switch(e.subject,e.subject){case"CmdDidFocusIntoPage":runPageMetadataHeuristicsOnActiveTab();break;case"CmdCheckEstablishSession":CheckEstablishSession();break;case"SaveStage1LoginName":o.hostname,t.tab.id,e.theLogin,g_tabIdToURL.set(t.tab.id,o.hostname),g_Stage1Logins.set(o.hostname,e.theLogin);break;case"CmdGetPassword4LoginName":let s=JSON.stringify({ACT:actSearch,URL:o.hostname,USR:e.theLogin}),a=g_secretSession.createSMSG(s),n={cmd:5,tabId:t.tab.id,frameId:t.frameId,url:e.theURL,payload:JSON.stringify({QID:e.subject,SMSG:a})};e.subject,e.subject,g_nativeAppPort.postMessage(n);break;case"CmdSetPassword4LoginName_URL":case"CmdNewAccount4URL":if(g_theState===ContextState.SessionKeySet){e.theNLogin,o.hostname;let s=consultStage1Logins(e.theNLogin,o.hostname);if(!isStringEmpty(s)){let o=JSON.stringify({ACT:actMaybeAdd,URL:e.theURL,USR:e.theLogin,PWD:e.thePassword,NURL:e.theNURL,NUSR:s,NPWD:e.theNPassword}),a=g_secretSession.createSMSG(o),n={cmd:6,tabId:t.tab.id,frameId:t.frameId,payload:JSON.stringify({QID:e.subject,SMSG:a})};e.subject,g_nativeAppPort.postMessage(n)}}break;case"CmdSetIconNTitle":{let s=e.hostPageType;setIsDark(e.isDark);let a=!1;switch(s){case WBSAutoFillFormTypeUndetermined:case WBSAutoFillFormTypeAutoFillableStandard:case WBSAutoFillFormTypeNonAutoFillable:a=!1;break;case WBSAutoFillFormTypeAutoFillableLogin:case WBSAutoFillFormTypeNewAccount:case WBSAutoFillFormTypeChangePassword:a=!0}switch(g_TabsToStateMap.has(t.tab.id)&&g_TabsToStateMap.get(t.tab.id)||g_TabsToStateMap.set(t.tab.id,a),o.hostname,t.tab.id,t.frameId,humanReadableFormType(e.hostPageType),e.hostPageType,e.hostPageType){case WBSAutoFillFormTypeUndetermined:case WBSAutoFillFormTypeAutoFillableStandard:case WBSAutoFillFormTypeNonAutoFillable:break;case WBSAutoFillFormTypeAutoFillableLogin:case WBSAutoFillFormTypeNewAccount:case WBSAutoFillFormTypeChangePassword:let e={cmd:3,tabId:t.tab.id,frameId:t.frameId,payload:JSON.stringify({TID:"CmdSetIconNTitle",URL:o.hostname})};JSON.stringify(e),g_nativeAppPort.postMessage(e)}}break;case"CmdClearCache":g_tabIdToURL.has(t.tab.id)&&(strURL=g_tabIdToURL.get(t.tab.id),o.hostname!==strURL&&g_Stage1Logins.delete(strURL),g_tabIdToURL.delete(t.tab.id));break;case"ThemeChanged":chrome.action&&(setIsDark(e.isDark),chrome.action.setIcon({path:imageDataForName(g_lastToolbarIconImageName)}));break;case"fillOneTimeCodeIntoForm":chrome.webNavigation.getFrame({tabId:t.tab.id,frameId:t.frameId},(s=>{s.frameId=t.frameId,didFillOneTimeCode(e.oneTimeCode,{id:t.tab.id},s)}));break;case"typedUserNameChanged":case"keydown":g_portToCompletionList.postMessage(e);break;case"CmdAddSetUpTOTPContextMenu":const r=!1;chrome.contextMenus.create({title:r?`${g_localizer.getMessage("divTOTPMenu")} (${e.totpSetupURL})`:g_localizer.getMessage("divTOTPMenu"),id:e.totpSetupURL,contexts:["all"]}),chrome.contextMenus.onClicked.addListener(onSetUpTOTPContextMenuClicked);break;case"CmdRemoveSetUpTOTPContextMenus":chrome.contextMenus.removeAll()}return!0}));try{(g_nativeAppPort=chrome.runtime.connectNative("com.apple.passwordmanager")).onMessage.addListener((function(e){switch(JSON.stringify(e),chrome.storage.local.remove(["lastRetryTimestamp"]),cmd2string(e.cmd),e.cmd,e.cmd){case 9:case 10:resetTheSession(ContextState.CheckEngine),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){setToolbarIcon("PasswordsToolbarUnpaired")})),setGlobalState(ContextState.NotInSession,!0);break;case 2:switch(e.payload.QID,e.payload.QID){case"m0":thePAKE=e.payload.PAKE,setGlobalState(ContextState.MSG1Set);break;case"m2":try{g_secretSession.processMessage(e.payload.PAKE);setGlobalState(ContextState.SessionKeySet),thePAKE=null}catch(e){e.code,e.message,resetTheSession(ContextState.NotInSession)}}break;case 3:var t=RememberIC.UnknownPage;switch(e.payload,e.payload){case"DoNotRemember":t=RememberIC.DoNotRemember;break;case"RememberLoginAndPassword":t=RememberIC.RememberLoginAndPassword;break;case"UnknownPage":t=RememberIC.UnknownPage;break;case"NoValueSet":t=RememberIC.NoValueSet,STATUSErrorReturned(e.STATUS)}try{chrome.tabs.sendMessage(e.tabId,{from:"background",subject:"RememberICSelection",tabId:e.tabId,frameId:e.frameId,theRememberICSelection:t,capabilities:g_nativeAppCapabilities},{frameId:e.frameId})}catch(t){e.tabId,e.frameId,t.message}break;case 4:t=RememberIC.UnknownPage;var s=[],o=[],a=[],n=e.payload,r=e.tabId,i=e.frameId,c=g_secretSession.parseSMSG(n.SMSG);switch((d=JSON.parse(c)).STATUS){case QueryStatus.Success:performance.now();var l=entriesFromLoginNames4URLData(d);l.sort(((e,t)=>e.USR.localeCompare(t.USR,void 0,{numeric:!0,sensitivity:"base"}))),l.forEach((e=>{if("Passwords not saved"===e.USR)t=RememberIC.DoNotRemember;else if(s.push(e.USR),o.push(e.CDate||e.ModDate),a.push(e.sites[0]),"Not Included"===e.PWD)t=RememberIC.RememberLoginAndPassword;else t=RememberIC.UnknownPage})),sendMessageToPopupAndCompletionList({from:"background",subject:"users",arrLoginNames:s,arrDates:o,arrHLDs:a,tabId:r,frameId:i,theRememberICSelection:t});break;case QueryStatus.NoResults:sendMessageToPopupAndCompletionList({from:"background",subject:"users",arrDates:[],tabId:r,frameId:i,arrLoginNames:[],arrHLDs:[],theRememberICSelection:RememberIC.UnknownPage});break;default:STATUSErrorReturned(d.STATUS)}break;case 5:var d;n=e.payload,c=g_secretSession.parseSMSG(n.SMSG);switch((d=JSON.parse(c)).STATUS){case QueryStatus.Success:chrome.tabs.query({active:!0,currentWindow:!0},(function(t){try{entriesFromLoginNames4URLData(d).forEach((s=>{for(site of s.sites)if(site===e.url)return void chrome.tabs.sendMessage(t[0].id,{from:"background",subject:"password",tabId:e.tabId,frameId:e.frameId,theLoginName:s.USR,thePassword:s.PWD,theURL:site},{frameId:e.frameId})}))}catch(t){e.tabId,e.frameId,t.message}}));break;case QueryStatus.NoResults:break;default:STATUSErrorReturned(d.STATUS)}break;case 16:handleGetOneTimeCodesCommand(e);break;case 8:case 7:case 6:break;case 14:g_nativeAppCapabilities=e.capabilities?e.capabilities:DefaultCapabilities,g_localizer=new Localizer(g_nativeAppCapabilities),sendMessageToPopupAndCompletionList({subject:"hello",capabilities:g_nativeAppCapabilities}),resetTheSession(ContextState.NotInSession);break;case 15:handleOneTimeCodeAvailableCommand(e);break;case 17:handleDidFillOneTimeCodeCommand(e);break;case 18:{let e=g_secretSession.parseSMSG(n.SMSG),t=JSON.parse(e);if(JSON.stringify(t),t.STATUS===QueryStatus.Success);else STATUSErrorReturned(t.STATUS);break}default:cmd2string(e.cmd)}})),g_nativeAppPort.onDisconnect.addListener((function(e){const t=chrome.runtime.lastError;t.message,chrome.alarms.create("TryReconnect",{when:1e3}),chrome.alarms.onAlarm.addListener((()=>{if(t.message,"Native host has exited."===t.message)chrome.storage.local.get(["lastRetryTimestamp"],(e=>{const t=e.lastRetryTimestamp;let s=!1;if(t){s=Date.now()-t>5e3}else s=!0;s?(chrome.storage.local.set({lastRetryTimestamp:Date.now()}),connectToBackgroundNativeAppAndSetUpListeners()):(chrome.storage.local.remove(["lastRetryTimestamp"]),resetTheSession(ContextState.NativeSupportNotInstalled))}));else t.message,resetTheSession(ContextState.NativeSupportNotInstalled);chrome.alarms.clear("TryReconnect")}))})),g_nativeAppPort.postMessage({cmd:14})}catch(e){resetTheSession(ContextState.NativeSupportNotInstalled)}}function handleOneTimeCodeAvailableCommand(e){getCurrentActiveTabAndFrame().then((e=>getOneTimeCodes(e[0],e[1],null))).catch((e=>{}))}function handleGetOneTimeCodesCommand(e){let t=null;try{t=JSON.parse(g_secretSession.parseSMSG(e.payload.SMSG))}catch(e){return}let s=t.STATUS;if(s!==QueryStatus.Success)return s!==QueryStatus.NoResults&&STATUSErrorReturned(s),void sendMessageToPopupAndCompletionList({from:"background",subject:"oneTimeCodes",oneTimeCodes:[]});let o=t.Entries;o&&sendMessageToPopupAndCompletionList({from:"background",subject:"oneTimeCodes",oneTimeCodes:o})}function handleDidFillOneTimeCodeCommand(e){let t=null;try{t=JSON.parse(g_secretSession.parseSMSG(e.payload.SMSG))}catch(e){return}let s=t.STATUS;if(s!==QueryStatus.Success)return void(s!==QueryStatus.NoResults&&STATUSErrorReturned(s));let o=t.Entries;o&&o.length&&chrome.tabs.sendMessage(e.tabId,{subject:"fillCurrentTOTPCodeIntoForm",oneTimeCodes:o},{frameId:e.frameId})}function CheckEstablishSession(){if(g_theState===ContextState.NotInSession)ChallengePIN()}function RunHeuristics(e,t,s){g_theState!==ContextState.MSG1Set&&g_theState!==ContextState.ChallengeSent||PINSet("");try{chrome.tabs.sendMessage(t,{from:"background",subject:"runFormMetadataHeuristics",url:e,tabId:t,frameId:s,capabilities:g_nativeAppCapabilities},{frameId:s})}catch(e){e.message}}function startiCloudControlPanel(){var e={cmd:11};JSON.stringify(e),g_nativeAppPort.postMessage(e)}function startPasswordsApp(){let e={cmd:13};JSON.stringify(e),g_nativeAppPort.postMessage(e)}function setUpTOTP(e,t){var s={cmd:13,setUpTOTPPageURL:e,setUpTOTPURI:t};JSON.stringify(s),g_nativeAppPort.postMessage(s)}function GetLoginNames4URL(e,t,s){let o=JSON.stringify({ACT:actGhostSearch,URL:e}),a=g_secretSession.createSMSG(o),n={cmd:4,url:e,tabId:t,frameId:s,payload:JSON.stringify({QID:"CmdGetLoginNames4URL",SMSG:a})};g_timeStartedFetchingCredentials=performance.now(),g_nativeAppPort.postMessage(n)}function getOneTimeCodes(e,t,s){getAllParentFrameURLsOfFrame(e,t).then((o=>{let a={ACT:actGhostSearch,TYPE:"oneTimeCodes",frameURLs:o};s&&(a.username=s);let n=g_secretSession.createSMSG(a),r={cmd:16,tabId:e.id,frameId:t.frameId,payload:JSON.stringify({QID:"CmdGetOneTimeCodes",SMSG:n})};g_nativeAppPort.postMessage(r)})).catch((e=>{}))}function didFillOneTimeCode(e,t,s){if("totp"===e.source)getAllParentFrameURLsOfFrame(t,s).then((o=>{let a={ACT:actSearch,TYPE:"oneTimeCodes",frameURLs:o},n=e.username;n&&(a.username=n);let r=g_secretSession.createSMSG(a),i={cmd:17,tabId:t.id,frameId:s.frameId,payload:JSON.stringify({QID:"CmdDidFillOneTimeCode",SMSG:r})};g_nativeAppPort.postMessage(i)})).catch((e=>{}))}function openURLInSafari(e){g_nativeAppPort.postMessage({cmd:1984,url:e})}function getAllParentFrameURLsOfFrame(e,t){let s=e.id;return new Promise((o=>{-1!==t.parentFrameId?chrome.webNavigation.getFrame({tabId:s,frameId:t.parentFrameId},(s=>{getAllParentFrameURLsOfFrame(e,s).then((e=>{o([t.url].concat(e))})).catch((e=>{}))})):o([t.url])}))}function ChallengePIN(){var e={QID:"m0",PAKE:g_secretSession.initialMessage(),HSTBRSR:g_localizer.getMessage("browserName")},t={cmd:2,msg:JSON.stringify(e)};setGlobalState(ContextState.ChallengeSent);try{g_nativeAppPort.postMessage(t)}catch(e){e.message,resetTheSession(ContextState.NativeSupportNotInstalled)}}function PINSet(e){g_secretSession.setPin(e);try{let e={QID:"m2",PAKE:g_secretSession.processMessage(thePAKE)},t={cmd:2,msg:JSON.stringify(e)};g_nativeAppPort.postMessage(t)}catch(e){e.code,e.message,resetTheSession(ContextState.NotInSession)}}function runPageMetadataHeuristicsOnActiveTab(){chrome.tabs.query({active:!0,currentWindow:!0},(function(e){g_TabsToStateMap.delete(e[0].id),chrome.webNavigation.getAllFrames({tabId:e[0].id},(t=>{e[0].id,t.forEach(((t,s,o)=>{const a=new URL(t.url),n=a.protocol;"http:"===n||"https:"===n?(e[0].id,t.frameId,RunHeuristics(a.hostname,e[0].id,t.frameId)):t.url}))}))}))}function getCurrentActiveTabAndFrame(){return new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.webNavigation.getAllFrames({tabId:t[0].id},(function(s){e([t[0],s[0]])}))}))}))}function getCurrentActiveTabAndItsFrames(){return new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.webNavigation.getAllFrames({tabId:t[0].id},(function(s){e([t[0],s])}))}))}))}function canFillOneTimeCodes(){return(g_nativeAppCapabilities||DefaultCapabilities).canFillOneTimeCodes}function scanForOTPURI(){return(g_nativeAppCapabilities||DefaultCapabilities).scanForOTPURI}chrome.storage.local.get("isDark",(function(e){void 0!==e.isDark&&(g_isDark=e.isDark),g_lastToolbarIconImageName&&setToolbarIcon(g_lastToolbarIconImageName)})),setUpEventListners(),checkForValidOS()?connectToBackgroundNativeAppAndSetUpListeners():(chrome.storage.local.get("hideUnsupportedOSPrompt",(function(e){e.hideUnsupportedOSPrompt||(chrome.storage.local.set({hideUnsupportedOSPrompt:1}),window.alert(g_localizer.getMessage("unsupportedOS")))})),setGlobalState(ContextState.IncompatibleOS)),chrome.windows.onFocusChanged.addListener((e=>{g_nativeAppPort&&e!==chrome.windows.WINDOW_ID_NONE&&chrome.tabs.query({active:!0,currentWindow:!0},(function(e){let t={cmd:8,tabId:e[0].id,event:1};JSON.stringify(t),g_nativeAppPort.postMessage(t)}))}));var g_IsDirty=!1;function setUpPortToCompetionList(e){g_portToCompletionList=e,e.onMessage.addListener((function(t){switch(JSON.stringify(t),t.subject){case"getContextAndMetadataFromContent":getCurrentActiveTabAndItsFrames().then((function(t){const s=t[0].id;for(const o of t[1]){const t=o.frameId;chrome.tabs.sendMessage(s,{from:"background",subject:"getContextAndMetadataForActiveTextField"},{frameId:t},(function(o){o&&e.postMessage({subject:"replyForGetContextAndMetadataFromContent",state:g_theState,tabId:s,frameId:t,url:o.url,textFieldMetadata:o.textFieldMetadata,formMetadata:o.formMetadata,presetUserName:o.presetUserName,hostname:o.hostname,canFillOneTimeCodes:canFillOneTimeCodes()})}))}})).catch((e=>{}));break;case"GetLoginNames4URL":GetLoginNames4URL(t.hostname,t.tabId,t.frameId);break;case"getOneTimeCodes":const s=t.tabId,o=t.frameId;chrome.webNavigation.getFrame({tabId:s,frameId:o},(e=>{e.frameId=o,getOneTimeCodes({id:t.tabId},e,t.username)}));break;case"openPasswordManagerAndDismissCompletionList":startPasswordsApp(),chrome.tabs.sendMessage(t.tabId,{subject:"dismissCompletionList"},{frameId:t.frameId});break;case"openURLInSafari":openURLInSafari(t.url);break;case"resizeCompletionList":case"fillLoginIntoForm":case"fillOneTimeCodeIntoForm":case"dismissCompletionList":chrome.tabs.sendMessage(t.tabId,t,{frameId:t.frameId})}})),e.postMessage({subject:"hello",capabilities:g_nativeAppCapabilities})}function setUpPortToPopup(e){g_portToPopup=e,e.onMessage.addListener((function(t){switch(JSON.stringify(t),t.subject){case"getNativeConnectionState":e.postMessage({subject:"nativeConnectionStateChanged",state:g_theState,appStoreURL:g_urlToDownloadNativeSupport});break;case"tryToEstablishNativeConnectionInResponseToUserActivatingPopup":chrome.storage.local.set({lastRetryTimestamp:Date.now()}),connectToBackgroundNativeAppAndSetUpListeners();break;case"challengePIN":ChallengePIN();break;case"userEnteredPIN":PINSet(t.pin);break;case"GetLoginNames4URL":GetLoginNames4URL(t.hostname,t.tabId,t.frameId);break;case"openPasswordManager":startPasswordsApp();break;case"startiCloudControlPanel":startiCloudControlPanel();break;case"SetUpTOTP":setUpTOTP(t.theURL,t.theTOTPURI);break;case"openURLInSafari":openURLInSafari(t.url)}})),e.onDisconnect.addListener((function(){g_theState===ContextState.MSG1Set&&PINSet(""),g_portToPopup=null})),e.postMessage({subject:"hello",capabilities:g_nativeAppCapabilities})}chrome.tabs.onUpdated.addListener(((e,t,s)=>{switch(s.status){case"unloaded":break;case"loading":g_IsDirty=!0;break;case"complete":g_IsDirty&&(JSON.stringify(t),JSON.stringify(s),g_IsDirty=!1,runPageMetadataHeuristicsOnActiveTab())}})),chrome.tabs.onActivated.addListener((e=>{if(JSON.stringify(e),chrome.contextMenus.removeAll(),!g_nativeAppPort)return;let t={cmd:8,tabId:e.tabId,event:1};JSON.stringify(t),g_nativeAppPort.postMessage(t)})),chrome.tabs.onRemoved.addListener(((e,t)=>{if(JSON.stringify(t),!g_nativeAppPort)return;let s={cmd:8,tabId:e,event:0};JSON.stringify(s),g_nativeAppPort.postMessage(s),g_TabsToStateMap.delete(e)})),chrome.webNavigation.onHistoryStateUpdated.addListener((function(e){JSON.stringify(e),e.transitionQualifiers.includes("forward_back");try{const t=new URL(e.url);let s=e.tabId;chrome.webNavigation.getAllFrames({tabId:s},(e=>{e.forEach(((e,o,a)=>{JSON.stringify(e),chrome.tabs.sendMessage(s,{from:"background",subject:"historyStateDidUpdateInTab",url:t.hostname,tabId:s,frameId:e.frameId},{frameId:e.frameId})}))}))}catch(t){e.tabId,e.frameId,t.message}chrome.alarms.onAlarm.addListener((()=>{runPageMetadataHeuristicsOnActiveTab(),chrome.alarms.clear("PageMetadataHeuristicsOnActiveTab")})),chrome.alarms.create("PageMetadataHeuristicsOnActiveTab",{when:500})})),chrome.runtime.onConnect.addListener((function(e){e.name,"completionList"===e.name?setUpPortToCompetionList(e):"popup"===e.name?setUpPortToPopup(e):e.name})),chrome.app&&(chrome.manifest=chrome.app.getDetails());var injectScriptIntoTab=function(e){if(chrome.manifest){var t=chrome.manifest.content_scripts[0].js;for(let s of t)chrome.scripting.executeScript(e.id,{file:s})}};chrome.windows.getAll({populate:!0},(function(e){for(let o of e)for(var t=0,s=o.tabs.length;t<s;t++){const e=o.tabs[t];let s;try{s=new URL(e.url).protocol}catch(e){s=""}"http:"!==s&&"https:"!==s||injectScriptIntoTab(e)}}));