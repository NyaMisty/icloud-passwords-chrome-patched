var pwlog=void 0,pwerror=void 0;function isStringEmpty(e){return!e||0===e.length}function urlFromURLString(e){try{return new URL(e)}catch{return null}}function humanReadableFormType(e){switch(e){case WBSAutoFillFormTypeUndetermined:return"Undetermined";case WBSAutoFillFormTypeAutoFillableStandard:return"AutoFillable:Standard";case WBSAutoFillFormTypeNonAutoFillable:return"NonAutoFillable";case WBSAutoFillFormTypeAutoFillableLogin:return"AutoFillable:Login";case WBSAutoFillFormTypeNewAccount:return"NewAccount";case WBSAutoFillFormTypeChangePassword:return"ChangePassword";case WBSAutoFillFormTypeFoundTOTPURI:return"FoundTOTPUri"}return"Unrecognized"}function domainsForDisplayFromUsernamesAndDomains(e,t){const s=e.length;let a=t.map((function(e){return e.replace(/^(www|m)\./,"")})),n=[];for(var r=0;r<s;r++)n.push([e[r],a[r]]);for(r=0;r<s;r++){let e=[];for(var o=r+1;o<s;o++)n[r].join("\n")===n[o].join("\n")&&(e.length||e.push(r),e.push(o));for(let s of e)a[s]=t[s]}return a}function urlIsBrowserURL(e){const t=e.protocol;return"chrome:"===t||"edge:"===t||"about:"==t}function isExtensionContextInvalidatedError(e){return"Extension context invalidated."===e.message}function capabilitiesDeclaresMacOS(e){try{return"macos"===e.operatingSystem.name}catch{return!1}}class Localizer{static configureDocumentElementForLanguage(e,t){switch(t){case"he":case"ar":case"fa":e.setAttribute("dir","rtl"),e.setAttribute("lang",t)}}#e={};constructor(e){e&&(this.#e=e.operatingSystem)}getMessage(e,t,s){const a=this.messageNamesToTry(e);for(let e of a){let a;try{a=chrome.i18n.getMessage(e,t,s)}catch{a=chrome.i18n.getMessage(e,t)}if(a)return a}return""}messageNamesToTry(e){let t=[];const s=this.#e,a=s?s.name:void 0,n=s?s.majorVersion:void 0,r=s?s.minorVersion:void 0,o=void 0!==n;return a&&o&&void 0!==r&&t.push(`${e}_${a}_${n}_${r}`),a&&o&&t.push(`${e}_${a}_${n}`),a?t.push(`${e}_${a}`):t.push(`${e}_${this.#t}`),t.push(e),t}get#t(){return navigator.platform.startsWith("Mac")?"macos":"windows"}}class ExtensionSettings{#s=!1;#a=!0;#n=!0;eventTarget=new EventTarget;constructor(e=!1){this.#s=e,this.#r(),this.#o()}get enableInPageAutoFill(){return this.#a}set enableInPageAutoFill(e){this.#a=e,this.#i()}get allowExtensionToControlAutoFillSettings(){return this.#n}set allowExtensionToControlAutoFillSettings(e){this.#n=e,this.#c().then(this.#i.bind(this))}#c(){return this.#n?this.attemptToControlBrowserAutoFillSettings():this.clearControlOfBrowserAutoFillSettings()}async attemptToControlBrowserAutoFillSettings(){if(this.#s)throw new Error("This Settings instance does not allow writing browser settings");const e=await Promise.allSettled([null,null,null]);return this.#d(),e}async clearControlOfBrowserAutoFillSettings(){if(this.#s)throw new Error("This Settings instance does not allow writing browser settings");const e=await Promise.allSettled([this.#m(chrome.privacy.services.passwordSavingEnabled),this.#m(chrome.privacy.services.autofillCreditCardEnabled),this.#m(chrome.privacy.services.autofillAddressEnabled)]);return this.#d(),e}#r(){let e=new Promise((e=>{chrome.storage.sync.get({enableInPageAutoFill:!0,allowExtensionToControlAutoFillSettings:!0},(t=>{this.#a=t.enableInPageAutoFill,this.#n=t.allowExtensionToControlAutoFillSettings,e()}))}));return this.#s||(e=e.then(this.#c.bind(this))),e.then(this.#d.bind(this))}#i(){return new Promise((e=>{chrome.storage.sync.set({enableInPageAutoFill:this.#a,allowExtensionToControlAutoFillSettings:this.#n},e)})).then(this.#d.bind(this))}#o(){this.#s||(chrome.privacy.services.passwordSavingEnabled&&chrome.privacy.services.passwordSavingEnabled.onChange.addListener((e=>{this.#d()})),chrome.privacy.services.autofillCreditCardEnabled&&chrome.privacy.services.autofillCreditCardEnabled.onChange.addListener((e=>{this.#d()})),chrome.privacy.services.autofillAddressEnabled&&chrome.privacy.services.autofillAddressEnabled.onChange.addListener((e=>{this.#d()})))}#d(){const e=new CustomEvent("settingsChanged",{detail:{enableInPageAutoFill:this.#a}});this.eventTarget.dispatchEvent(e)}async#l(e,t){let s;try{s=await this.#u(e)}catch(e){return}if(s){if(s.value===t)return{details:s,newValue:t};try{s=await e.set({value:t})}catch(e){return}return{details:s,newValue:t}}}async#u(e){if(!e)throw new Error(`Unable to get ${e} setting.`);const t=await e.get({});if("not_controllable"===t.levelOfControl)throw new Error(`Cannot control ${e} setting.`);return t}async#m(e){if(!e)throw new Error(`Unable to clear browser setting: ${e}.`);await e.clear({})}}const ErrCodes={ErrSuccess:"Success",InvalidMessage:"InvalidMessage",UnexpectedMessage:"UnexpectedMessage",InvalidSyntax:"InvalidSyntax",InvalidSessionKey:"InvalidSessionKey",CryptoError:"CryptoError",InvalidUserName:"InvalidUserName"};class SecretSessionError extends Error{constructor(e,t=null){super(t),this.code=e}}const SecretSessionVersion={SRPWithOldVerification:0,SRPWithRFCVerification:1},scriptVersion="1.0",appVersion="1.0",MSGTypes={MSG0:0,MSG1:1,MSG2:2,MSG3:3};SecretSession=function(e){this.shouldUseBase64=!1,e.shouldUseBase64&&(this.shouldUseBase64=e.shouldUseBase64),this.protocolVersion=SecretSessionVersion.SRPWithOldVerification,e.secretSessionVersion&&(this.protocolVersion=e.secretSessionVersion),this.grp=sjcl.keyexchange.srp.knownGroup(3072),this.keyLen=128,this.tagLen=128,this.setUpSRP()},SecretSession.prototype={createSMSG:function(e){if("object"==typeof e)try{e=JSON.stringify(e)}catch(e){return ErrCodes.InvalidMessage}const t=sjcl.codec.utf8String.toBits(e),s=this.encrypt(t);if("string"==typeof s)return s;let a=null;try{a=JSON.stringify({TID:this.bitsToString(this.I.toBits()),SDATA:this.bitsToString(s,!1)})}catch(e){return ErrCodes.InvalidMessage}return a},parseSMSG:function(e){let t=e;if("string"==typeof t)try{t=JSON.parse(e)}catch(t){throw new SecretSessionError(ErrCodes.InvalidSyntax,`Unable to decode SMSG from string: ${t} ${e}`)}if("string"!=typeof t.SDATA)throw new SecretSessionError(ErrCodes.InvalidMessage,"Missing or invalid SDATA field in SMSG message.");if("string"!=typeof t.TID)throw new SecretSessionError(ErrCodes.InvalidUserName,"Missing or invalid 'TID' field in SMSG object.");const s=sjcl.bn.fromBits(this.stringToBits(t.TID));if(!this.I.equals(s))throw new SecretSessionError(ErrCodes.InvalidUserName,"Received SMSG message meant for another session.");return sjcl.codec.utf8String.fromBits(this.decrypt(this.stringToBits(t.SDATA)))},setPin:function(e){this.P=e},stringToBase64:function(e){let t=sjcl.codec.utf8String.toBits(e);return sjcl.codec.base64.fromBits(t,!1,!1)},bitsToString:function(e,t=!0){return this.shouldUseBase64?sjcl.codec.base64.fromBits(e):(t?"0x":"")+sjcl.codec.hex.fromBits(e)},stringToBits:function(e){return this.shouldUseBase64?sjcl.codec.base64.toBits(e):sjcl.codec.hex.toBits(e)},setUpSRP:function(){this.I=sjcl.bn.fromBits(this._randomWords(4)),this.a=sjcl.bn.fromBits(this._randomWords(8)),this.A=this.grp.g.powermod(this.a,this.grp.N)},currProtocols:function(){return[SecretSessionVersion.SRPWithOldVerification,SecretSessionVersion.SRPWithRFCVerification]},initialMessage:function(){this.expectedMessage=MSGTypes.MSG1;let e=null;try{e=JSON.stringify({TID:this.bitsToString(this.I.toBits()),MSG:0,A:this.bitsToString(this.A.toBits()),VER:"1.0",PROTO:this.currProtocols()})}catch(e){return null}return this.stringToBase64(e)},_padToModulusLength:function(e){e=e.replace(/^0x/,"");const t=2*(sjcl.bitArray.bitLength(this.grp.N.toBits())+7>>3)-e.length;if(0===t)return e;return"0".repeat(t)+e},processMessage:function(e){const t=sjcl.codec.utf8String.fromBits(sjcl.codec.base64.toBits(e));let s=null;try{s=JSON.parse(t)}catch(e){throw new SecretSessionError(ErrCodes.InvalidMessage,`Unable to parse JSON message: ${e}`)}if("string"!=typeof s.TID)throw new SecretSessionError(ErrCodes.InvalidMessage,"Missing or invalid 'TID' field in PAKE message.");let a=sjcl.bn.fromBits(this.stringToBits(s.TID));if(!this.I.equals(a))throw new SecretSessionError(ErrCodes.UnexpectedMessage,"Unexpected message");if(!s.MSG)throw new SecretSessionError(ErrCodes.InvalidMessage,"Missing 'MSG' field in PAKE message.");const n=parseInt(s.MSG,10);if(this.expectedMessage!==n)throw new SecretSessionError(ErrCodes.UnexpectedMessage,`Received Message ${message.MSG}, but expected Message ${this.expectedMessage} `);let r=null;if(n===MSGTypes.MSG1){var o=SecretSessionVersion.SRPWithOldVerification;"number"==typeof s.PROTO&&(o=s.PROTO,Object.values(SecretSessionVersion).includes(o)||(o=SecretSessionVersion.SRPWithOldVerification)),this.protocolVersion=o,r=this.processMessage1(s)}else n===MSGTypes.MSG3&&(r=this.processMessage3(s));return r},createSessionKey:function(e,t){const s=sjcl.hash.sha256.hash,a=this._calculateX(e,this.bitsToString(this.I.toBits()),this.P,s);this.v=this._calculateVerifier(this.grp.g,a,this.grp.N);const n=this.A.toString(),r=t.toString(),o=this._padToModulusLength(n).concat(this._padToModulusLength(r)),i=sjcl.bn.fromBits(s(sjcl.codec.hex.toBits(o))),c=this.a.add(i.mul(a)),l=this.grp.N.toString()+this._padToModulusLength(this.grp.g.toString()),d=sjcl.bn.fromBits(s(sjcl.codec.hex.toBits(l))).mulmod(this.v,this.grp.N);return s(t.sub(d).powermod(c,this.grp.N).toBits())},_calculateX:function(e,t,s,a){const n=a(t+":"+s);return sjcl.bn.fromBits(a(e.concat(n)))},_calculateVerifier:function(e,t,s){return e.powermod(t,s)},_calculateM:function(e,t,s){const a=sjcl.hash.sha256.hash;let n=a(this.grp.N.toBits()),r=a(sjcl.codec.hex.toBits(this._padToModulusLength(this.grp.g.toString())));const o=sjcl.bitArray.bitLength(n)/32;for(let e=0;e<o;++e)n[e]=n[e]^r[e];let i=a(this.bitsToString(this.I.toBits())),c=new sjcl.hash.sha256;c.update(n),c.update(i),c.update(e),c.update(this.A.toBits()),c.update(t.toBits()),c.update(s);let l=c.finalize();return c=new sjcl.hash.sha256,c.update(this.A.toBits()),c.update(l),c.update(s),this.hamk=c.finalize(),l},processMessage1:function(e){if("string"!=typeof e.s||"string"!=typeof e.B)throw new SecretSessionError(ErrCodes.InvalidMessage,"Message 1 is missing some required keys.");e.VER&&(this.appVer=e.VER);const t=this.stringToBits(e.s),s=sjcl.bn.fromBits(this.stringToBits(e.B));let a=new sjcl.bn(1);if(0==s.mulmod(a,this.grp.N))throw new SecretSessionError(ErrCodes.CryptoError,"B.mulmod error");const n=this.createSessionKey(t,s);this.encKey=sjcl.bitArray.bitSlice(n,0,this.keyLen),this.expectedMessage=MSGTypes.MSG3;let r={TID:this.bitsToString(this.I.toBits()),MSG:2};switch(this.protocolVersion){case SecretSessionVersion.SRPWithRFCVerification:r.M=this.bitsToString(this._calculateM(t,s,n),!1);break;case SecretSessionVersion.SRPWithOldVerification:const e=this.shouldUseBase64?this.v.toBits():sjcl.codec.utf8String.toBits(this.v.toString()),a=this.encrypt(e);r.v=this.bitsToString(a,!1);break;default:throw new SecretSessionError(ErrCodes.UnexpectedMessage,`Unknown protocol version ${this.protocolVersion}`)}let o=null;try{o=JSON.stringify(r)}catch(e){throw new SecretSessionError(ErrCodes.InvalidMessage,`Error encoding Message 2 to string:${e}`)}return this.stringToBase64(o)},processMessage3:function(e){let t=ErrCodes.ErrSuccess,s="";if(0!==e.ErrCode)s=`Message 3 contained an error: ${e.ErrCode}`,t=ErrCodes.InvalidMessage;else switch(this.protocolVersion){case SecretSessionVersion.SRPWithRFCVerification:if(e.HAMK){const a=this.stringToBits(e.HAMK);sjcl.bitArray.equal(a,this.hamk)||(s="Failed to verify server data.",this.msgExp=MSGTypes.MSG1,t=ErrCodes.InvalidSessionKey)}else s=`Message 3 does not contain necessary data:${e.ErrCode}`,t=ErrCodes.InvalidMessage;break;case SecretSessionVersion.SRPWithOldVerification:break;default:t=ErrCode.UnexpectedMessage,s=`Unknown SecretSessionVersion ${this.protocolVersion}.`}if(t!=ErrCodes.ErrSuccess)throw this.sessionKey=null,this.expectedMessage=MSGTypes.MSG1,new SecretSessionError(t,s);return t===ErrCodes.ErrSuccess},encrypt:function(e){if(!this.encKey)throw new SecretSessionError(ErrCodes.InvalidSessionKey,"Called encrypt() without a session key");const t=new sjcl.cipher.aes(this.encKey),s=this._randomWords(4);let a=null;try{a=sjcl.mode.gcm.encrypt(t,e,s)}catch(e){throw new SecretSessionError(ErrCodes.CryptoError,e.message)}return sjcl.bitArray.concat(a,s)},decrypt:function(e){if(!this.encKey)throw new SecretSessionError(ErrCodes.InvalidSessionKey,"Called decrypt() without a session key!");const t=new sjcl.cipher.aes(this.encKey),s=sjcl.bitArray.bitSlice(e,0,this.keyLen),a=sjcl.bitArray.bitSlice(e,this.keyLen);let n=null;try{n=sjcl.mode.gcm.decrypt(t,a,s)}catch(e){throw new SecretSessionError(ErrCodes.CryptoError,`Exception while decrypting message. ${e}`)}return n},_randomWords:function(e){const t=new Int32Array(e);return self.crypto.getRandomValues(t),Array.from(t)}};const ContextState={IncompatibleOS:"IncompatibleOS",NotInSession:"NotInSession",NativeSupportNotInstalled:"NativeSupportNotInstalled",CheckEngine:"CheckEngine",ChallengeSent:"ChallengeSent",MSG1Set:"MSG1Set",SessionKeySet:"SessionKeySet"},DataState={Initial:"Initial",Frame0Processed:"Frame0Processed",DataProcessed:"DataProcessed"},RememberIC={NoValueSet:"NoValueSet",UnknownPage:"UnknownPage",DoNotRemember:"DoNotRemember",RememberLoginAndPassword:"RememberLoginAndPassword"},WBSAutoFillFormTypeUndetermined=0,WBSAutoFillFormTypeAutoFillableStandard=1,WBSAutoFillFormTypeNonAutoFillable=2,WBSAutoFillFormTypeAutoFillableLogin=3,WBSAutoFillFormTypeNewAccount=4,WBSAutoFillFormTypeChangePassword=5,WBSAutoFillFormTypeFoundTOTPURI=6;class FrameDoesNotExistError extends Error{frame;constructor(e){super(`Frame ${e.id} does not exist in tab ${e.tab.id}`),this.frame=e}}class FrameIsBrowserFrameError extends Error{frame;constructor(e){super(`Frame ${e.id} in tab ${e.tab.id} is a browser frame.`),this.frame=e}}class ContentScriptNotSetUpInFrame extends Error{frame;constructor(e){super(`Frame ${e.id} in tab ${e.tab.id} does not have active content script.`),this.frame=e}}class PromiseFulfillment{resolve;reject;constructor(e,t){this.resolve=e,this.reject=t}}class DelayedMessageSender{static defaultDelayMS=50;delayMS;messageName;#g=null;#p=[];#h=null;constructor(e,t=DelayedMessageSender.defaultDelayMS){this.messageName=e,this.delayMS=t}get dateOfLastSentMessage(){return this.#h}enqueueRequest(e,t){return new Promise(((s,a)=>{this.#p.push(new PromiseFulfillment(s,a)),this.#g&&(clearTimeout(this.#g),this.#g=null),this.#g=setTimeout((async()=>{const s=e.tab.id,a=e.id;let n;try{n=await this.#S(s,a,this.messageName,t)}catch(t){let s=t;return t.message.includes("Receiving end does not exist.")&&(s=new FrameDoesNotExistError(e)),this.#h=null,void this.#f(null,s)}finally{this.#g=null}this.#h=new Date,this.#f(n)}).bind(this),this.delayMS)}))}cancelPendingRequests(){this.#g&&(clearTimeout(this.#g),this.#g=null),this.#f(null,new Error("Cancelled"))}reset(){this.cancelPendingRequests(),this.#h=null}#S(e,t,s,a){let n={subject:s};return a&&(n={...n,...a}),chrome.tabs.sendMessage(e,n,{frameId:t})}#f(e,t=null){for(;this.#p.length;){const s=this.#p.shift();t?s.reject(t):s.resolve(e)}}}class Frame{static delayForSettingUpContentScriptAfterFrameCreationMS=50;static delayForRunningHeuristicsAfterFrameUpdateMS=50;id;tab;url;state;#b=new DelayedMessageSender("setUp",Frame.delayForSettingUpContentScriptAfterFrameCreationMS);#C=new DelayedMessageSender("runFormMetadataHeuristics",Frame.delayForRunningHeuristicsAfterFrameUpdateMS);constructor(e,t){this.id=e,this.tab=t}get isBrowserFrame(){const e=this.url;return!!e&&urlIsBrowserURL(e)}get hasCompletedLoad(){return"complete"===this.state}get hasSetUpContentScript(){return!!this.#b.dateOfLastSentMessage}prepareForRemoval(){this.#b.cancelPendingRequests(),this.#C.cancelPendingRequests()}updateWithDetails(e,t){this.state=e;const s=t.url;s&&(this.url=urlFromURLString(s))}setUpContentScript(e){return this.isBrowserFrame?Promise.reject(new FrameIsBrowserFrameError(this)):(e=!!e,this.#b.enqueueRequest(this,{shouldEnableQRCodeScanning:e}))}async enableQRCodeScanning(e){return this.hasSetUpContentScript?this.#S("enableQRCodeScanner",{isEnabled:e}):Promise.reject(new ContentScriptNotSetUpInFrame(this))}runHeuristics(){return this.isBrowserFrame?Promise.reject(new FrameIsBrowserFrameError(this)):this.hasSetUpContentScript?this.#C.enqueueRequest(this):Promise.reject(new Error("Cannot run metadata heuristics before setting up content script"))}readyToReceiveMessages(){return this.#b.reset(),this.setUpContentScript(!0)}#S(e,t){let s={subject:e};return t&&(s={...s,...t}),chrome.tabs.sendMessage(this.tab.id,s,{frameId:this.id})}}class Tab{static delayForSettingUpFrameContentScript=50;static delayForCleaningUpFrames=2e3;static enableDeferredFrameCleanup=!0;id;state;framesById=new Map;url;#T=null;constructor(e){this.id=e}get allFrames(){return chrome.webNavigation.getAllFrames({tabId:this.id})}async injectContentScripts(e=!0){if(!this.url)return;const t=this.url.protocol;if("http:"!==t&&"https:"!==t)return;const s=chrome.runtime.getManifest().content_scripts[0],a=this.id;await chrome.scripting.executeScript({target:{tabId:a,allFrames:e},files:s.js});for(const e of this.framesById.values())try{await e.setUpContentScript()}catch(e){if(e instanceof FrameIsBrowserFrameError)return}}prepareForRemoval(){for(const e of this.framesById.values())e.prepareForRemoval()}activated(e){this.#I(),chrome.contextMenus&&chrome.contextMenus.removeAll()}update(e,t){this.#I(),this.state=t.status,e?(this.state=e.status,"loading"===e.status&&(this.url=urlFromURLString(e.url))):(this.state=t.status,this.url=urlFromURLString(t.url))}addNewFrame(e,t,s=null){this.#I();const a=t.frameId,n=new Frame(a,this);this.framesById.set(a,n),this.frameUpdated(e,a,s,t)}async frameUpdated(e,t,s,a){this.#I();const n=this.ensureFrameExists(t);if(n.updateWithDetails(s,a),n.hasCompletedLoad)try{n.hasSetUpContentScript?await n.runHeuristics():await n.setUpContentScript(e.shouldEnableQRCodeScanning)}catch(e){if(!(e instanceof FrameDoesNotExistError)){if(e instanceof FrameIsBrowserFrameError)return;throw e}{const t=e.frameId;if(!this.framesById.get(t))return;let s=await chrome.webNavigation.getFrame({tabId:this.id,frameId:t});s||(s.prepareForRemoval(),this.framesById.delete(t))}}}async frameCompleted(e,t,s){try{await this.frameUpdated(e,t,"complete",s)}catch(e){}}frameIsReadyToReceiveMessages(e){return this.ensureFrameExists(e).readyToReceiveMessages()}ensureFrameExists(e){let t=this.framesById.get(e);return t||(t=new Frame(e,this),this.framesById.set(e,t)),t}#I(){Tab.enableDeferredFrameCleanup&&(this.#T&&(clearTimeout(this.#T),this.#T=null),this.#T=setTimeout((async()=>{let e=new Map;const t=await this.allFrames,s=new Set((t||[]).map((e=>e.frameId)));if(!s.size&&!this.framesById.size)return;for(const[t,a]of this.framesById)s.has(t)&&e.set(t,a);this.framesById.size,e.size;this.framesById=e,this.#T=null}).bind(this),Tab.delayForCleaningUpFrames))}}class TabMonitor{tabsById=new Map;#w;#y;constructor(){this.#A(),this.#v()}get extensionIsPaired(){return this.#w}set extensionIsPaired(e){this.#w=e,this.#F()}get nativeAppSupportsQRCodeScanning(){return this.#y}set nativeAppSupportsQRCodeScanning(e){this.#y=e,this.#F()}get shouldEnableQRCodeScanning(){return this.#w&&this.#y}get#M(){return[...this.tabsById.values()].flatMap((e=>[...e.framesById.values()]))}#F(){const e=this.shouldEnableQRCodeScanning;return Promise.allSettled(this.#M.map((t=>t.enableQRCodeScanning(e).catch((e=>{})))))}async#A(){const e=await chrome.tabs.query({});for(const t of e){const e=t.id,s=new Tab(e);s.update(null,t),this.tabsById.set(e,s);const a=await chrome.webNavigation.getAllFrames({tabId:e});for(const e of a){if(void 0===e.frameId)break;s.addNewFrame(this,e,t.status)}}}#v(){chrome.tabs.onCreated.addListener((e=>{const t=e.id;this.tabsById.set(t,new Tab(t))})),chrome.tabs.onUpdated.addListener(((e,t,s)=>{this.ensureTabExists(e).update(t,s)})),chrome.tabs.onActivated.addListener((e=>{this.ensureTabExists(e.tabId).activated(e)})),chrome.tabs.onRemoved.addListener(((e,t)=>{this.tabsById.delete(e)})),chrome.webNavigation.onBeforeNavigate.addListener((e=>{const t=e.tabId;this.ensureTabExists(t).addNewFrame(this,e)})),chrome.webNavigation.onCompleted.addListener((async e=>{const t=e.tabId,s=e.frameId,a=this.ensureTabExists(t);try{await a.frameCompleted(this,s,e)}catch(e){}})),chrome.webNavigation.onHistoryStateUpdated.addListener((async e=>{const t=e.tabId,s=e.frameId,a=this.ensureTabExists(t);try{await a.frameUpdated(this,s,"updated",e)}catch(e){}})),chrome.webNavigation.onTabReplaced.addListener((e=>{const t=e.replacedTabId;this.tabsById.get(t).prepareForRemoval(),this.tabsById.delete(t);const s=e.tabId;this.tabsById.set(s,new Tab(s))}))}async performInitialSetup(){for(const e of this.tabsById.values())await e.injectContentScripts()}ensureTabExists(e){let t=this.tabsById.get(e);return t||(t=new Tab(e),this.tabsById.set(e,t)),t}frameIsReadyToReceiveMessages(e,t){return this.ensureTabExists(e).frameIsReadyToReceiveMessages(t)}}"function"==typeof importScripts&&importScripts("/sjcl.js");const CmdEndOp=0,CmdUnused1=1,CmdChallengePIN=2,CmdSetIconNTitle=3,CmdGetLoginNames4URL=4,CmdGetPassword4LoginName=5,CmdSetPassword4LoginName_URL=6,CmdNewAccount4URL=7,CmdTabEvent=8,CmdPasswordsDisabled=9,CmdReloginNeeded=10,CmdLaunchiCP=11,CmdiCPStateChange=12,CmdLaunchPasswordsApp=13,CmdHello=14,CmdOneTimeCodeAvailable=15,CmdGetOneTimeCodes=16,CmdDidFillOneTimeCode=17,CmdSetUpTOTPGenerator=18,CmdOpenURLInSafari=1984,QueryStatus={Success:0,NoResults:3};function cmd2string(e){switch(e){case 0:return"CmdEndOp";case 1:return"CmdUnused1";case 2:return"CmdChallengePIN";case 3:return"CmdSetIconNTitle";case 4:return"CmdGetLoginNames4URL";case 5:return"CmdGetPassword4LoginName";case 6:return"CmdSetPassword4LoginName_URL";case 7:return"CmdNewAccount4URL";case 8:return"CmdTabEvent";case 9:return"CmdPasswordsDisabled";case 10:return"CmdReloginNeeded";case 11:return"CmdLaunchiCP";case 12:return"CmdiCPStateChange";case 13:return"CmdLaunchPasswordsApp";case 14:return"CmdHello";case 15:return"CmdOneTimeCodeAvailable";case 16:return"CmdGetOneTimeCodes";case 17:return"CmdDidFillOneTimeCode";case 1984:return"CmdOpenURLInSafari";default:return"Unknown Command"}}var actUnknown=-1,actDelete=0,actUpdate=1,actSearch=2,actAddNew=3,actMaybeAdd=4,actGhostSearch=5;const DefaultCapabilities={shouldUseBase64:!1,secretSessionVersion:SecretSessionVersion.SRPWithOldVerification,canFillOneTimeCodes:!1,operatingSystem:{},supportsSubURLs:!1,scanForOTPURI:!1},AmountOfTimeToBlockRefreshForNativeAppDisconnection=5e3;let g_tabMonitor=new TabMonitor;var g_lastToolbarIconImageName,g_timeStartedFetchingCredentials,g_nativeAppPort=null,g_portToCompletionList=null,g_portToPopup=null,thePAKE=null,g_theState=ContextState.NotInSession,g_tabIdToURL=new Map,g_Stage1Logins=new Map,g_TabsToStateMap=new Map,g_ErrorReturned=!1,g_secretSession=null,g_nativeAppCapabilities=null,g_localizer=new Localizer,g_extensionSettings=new ExtensionSettings,g_urlToDownloadNativeSupport="https://support.apple.com/kb/DL1455",g_isDark=!1;function setIsDark(e){g_isDark!==e&&(g_isDark=e,chrome.storage.local.set({isDark:e}))}function imageDataForName(e){if(e)return{16:"images/"+(g_lastToolbarIconImageName=e)+(g_isDark?"-darkmode":"")+"_icon16.png",32:"images/"+g_lastToolbarIconImageName+(g_isDark?"-darkmode":"")+"_icon32.png"}}function setUpEventListners(){chrome.runtime.onInstalled&&chrome.runtime.onInstalled.addListener((async e=>{await g_tabMonitor.performInitialSetup(),chrome.declarativeContent&&chrome.declarativeContent.onPageChanged.removeRules(void 0,(function(){chrome.declarativeContent.onPageChanged.addRules([{conditions:[new chrome.declarativeContent.PageStateMatcher({pageUrl:{schemes:["https","http"]}})],actions:[new chrome.declarativeContent.ShowPageAction]}])})),"install"===e.reason&&g_extensionSettings.attemptToControlBrowserAutoFillSettings().then((e=>{})).catch((e=>{}))})),chrome.runtime.onSuspend&&chrome.runtime.onSuspend.addListener((function(){g_tabIdToURL.clear(),g_Stage1Logins.clear(),g_TabsToStateMap.clear(),g_nativeAppPort.postMessage({cmd:0})})),chrome.runtime.onSuspendCanceled&&chrome.runtime.onSuspendCanceled.addListener((function(){})),chrome.runtime.onUpdateAvailable&&chrome.runtime.onUpdateAvailable.addListener((function(){}))}function secdSTATUS2string(e){switch(e){case 0:return"secdSTATUSsuccess";case 1:return"genericError";case 2:return"invalidParam";case 3:return"itemNotFound";case 4:return"failedToDelete";case 5:return"failedToUpdate";case 6:return"invalidMessageFormat";case 7:return"duplicateItem";case 8:return"unknownAction";case 9:return"invalidSession"}}function checkForValidOS(){if("MacIntel"===navigator.platform)return g_urlToDownloadNativeSupport="https://www.apple.com/macos",!0;const e=new RegExp("\\(Windows\\s*\\w*\\s*(\\d*)\\.(\\d*)","i").exec(navigator.userAgent);return null!==e&&3===e.length&&(e[1]>=10?(g_urlToDownloadNativeSupport="ms-windows-store://pdp/?productid=9PKTQ5699M62",!0):!(e[1]<6)&&!(e[2]<1))}function setGlobalState(e,t){g_theState=e,g_tabMonitor.extensionIsPaired=g_theState===ContextState.SessionKeySet,setToolbarIcon(g_theState===ContextState.SessionKeySet?"PasswordsToolbar":"PasswordsToolbarUnpaired"),t||sendMessageToPopup({subject:"nativeConnectionStateChanged",state:g_theState,appStoreURL:g_urlToDownloadNativeSupport})}function resetTheSession(e){setGlobalState(e),g_secretSession=new SecretSession(g_nativeAppCapabilities)}function STATUSErrorReturned(e){switch(secdSTATUS2string(e),g_theState){case ContextState.IncompatibleOS:case ContextState.NativeSupportNotInstalled:case ContextState.CheckEngine:case ContextState.MSG1Set:case ContextState.ChallengeSent:break;case ContextState.SessionKeySet:g_ErrorReturned=!0,resetTheSession(ContextState.NotInSession);case ContextState.NotInSession:chrome.tabs.query({active:!0,currentWindow:!0},(function(e){setToolbarIcon("PasswordsToolbarUnpaired")}))}}function logMapElements(e,t,s){}function consultStage1Logins(e,t){return isStringEmpty(e)?g_Stage1Logins.has(t)?(LoginName=g_Stage1Logins.get(t),LoginName,g_Stage1Logins.delete(t),LoginName):"":e}function entriesFromLoginNames4URLData(e){let t=e.Entries;return t||(t=[],Object.entries(e).sort().map((([e,s])=>{e.includes("Entry_")&&t.push(s)})),t)}function setToolbarIcon(e){chrome.action&&chrome.action.setIcon({path:imageDataForName(e)})}function sendMessageToPopupAndCompletionList(e){sendMessageToPopup(e),sendMessageToCompletionList(e)}function sendMessageToPopup(e){if(g_portToPopup)try{g_portToPopup.postMessage(e)}catch(e){}}function sendMessageToCompletionList(e){if(g_portToCompletionList)try{g_portToCompletionList.postMessage(e)}catch(e){}}function onSetUpTOTPContextMenuClicked(e,t){if(g_theState!==ContextState.SessionKeySet)window.alert(g_localizer.getMessage("enableAutoFillPasswordsMessage"));else{const t=new URL(e.pageUrl);t.hostname,e.menuItemId,setUpTOTP(t.hostname,e.menuItemId)}}function connectToBackgroundNativeAppAndSetUpListeners(){setToolbarIcon("PasswordsToolbarUnpaired"),g_nativeAppCapabilities||(g_nativeAppCapabilities=DefaultCapabilities),g_localizer=new Localizer(g_nativeAppCapabilities),g_secretSession=new SecretSession(g_nativeAppCapabilities),chrome.runtime.onMessage.addListener(((e,t,s)=>{const a=t.tab.id,n=t.frameId,r=new URL(t.url);if(r.hostname,t.tab.id,t.frameId,e.from,"content"===e.from)switch(e.subject,e.subject){case"CmdCheckEstablishSession":CheckEstablishSession();break;case"SaveStage1LoginName":g_tabIdToURL.has(a)&&(strURL=g_tabIdToURL.get(a),g_Stage1Logins.delete(strURL),g_tabIdToURL.delete(a)),r.hostname,e.theLogin,g_tabIdToURL.set(a,r.hostname),g_Stage1Logins.set(r.hostname,e.theLogin);break;case"CmdGetPassword4LoginName":const o=JSON.stringify({ACT:actSearch,URL:r.hostname,USR:e.theLogin}),i=g_secretSession.createSMSG(o),c={cmd:5,tabId:t.tab.id,frameId:t.frameId,url:e.theURL,payload:JSON.stringify({QID:e.subject,SMSG:i})};e.subject,e.subject,g_nativeAppPort.postMessage(c);break;case"CmdSetPassword4LoginName_URL":case"CmdNewAccount4URL":if(g_theState===ContextState.SessionKeySet){e.theNLogin,r.hostname;let s=consultStage1Logins(e.theNLogin,r.hostname);if(!isStringEmpty(s)){let a=JSON.stringify({ACT:actMaybeAdd,URL:"",USR:"",PWD:"",NURL:e.theNURL,NUSR:s,NPWD:e.theNPassword}),n=g_secretSession.createSMSG(a),r={cmd:6,tabId:t.tab.id,frameId:t.frameId,payload:JSON.stringify({QID:e.subject,SMSG:n})};e.subject,g_nativeAppPort.postMessage(r)}}break;case"CmdSetIconNTitle":{let s=e.hostPageType;setIsDark(e.isDark);let a=!1;switch(s){case WBSAutoFillFormTypeUndetermined:case WBSAutoFillFormTypeAutoFillableStandard:case WBSAutoFillFormTypeNonAutoFillable:a=!1;break;case WBSAutoFillFormTypeAutoFillableLogin:case WBSAutoFillFormTypeNewAccount:case WBSAutoFillFormTypeChangePassword:a=!0}switch(g_TabsToStateMap.has(t.tab.id)&&g_TabsToStateMap.get(t.tab.id)||g_TabsToStateMap.set(t.tab.id,a),r.hostname,t.tab.id,t.frameId,humanReadableFormType(e.hostPageType),e.hostPageType,e.hostPageType){case WBSAutoFillFormTypeUndetermined:case WBSAutoFillFormTypeAutoFillableStandard:case WBSAutoFillFormTypeNonAutoFillable:break;case WBSAutoFillFormTypeAutoFillableLogin:case WBSAutoFillFormTypeNewAccount:case WBSAutoFillFormTypeChangePassword:let e={cmd:3,tabId:t.tab.id,frameId:t.frameId,payload:JSON.stringify({TID:"CmdSetIconNTitle",URL:r.hostname})};JSON.stringify(e),g_nativeAppPort.postMessage(e)}}break;case"ThemeChanged":chrome.action&&(setIsDark(e.isDark),chrome.action.setIcon({path:imageDataForName(g_lastToolbarIconImageName)}));break;case"fillOneTimeCodeIntoForm":chrome.webNavigation.getFrame({tabId:t.tab.id,frameId:t.frameId},(s=>{s.frameId=t.frameId,didFillOneTimeCode(e.oneTimeCode,{id:t.tab.id},s)}));break;case"typedUserNameChanged":case"keydown":sendMessageToCompletionList(e);break;case"CmdAddSetUpTOTPContextMenu":const l=!1;if(!chrome.contextMenus)break;chrome.contextMenus.create({title:l?`${g_localizer.getMessage("divTOTPMenu")} (${e.totpSetupURL})`:g_localizer.getMessage("divTOTPMenu"),id:e.totpSetupURL,contexts:["all"]}),chrome.contextMenus.onClicked.addListener(onSetUpTOTPContextMenuClicked);break;case"CmdRemoveSetUpTOTPContextMenus":chrome.contextMenus&&chrome.contextMenus.removeAll();break;case"getCapabilities":s(g_nativeAppCapabilities);break;case"readyToReceiveMessages":g_tabMonitor.frameIsReadyToReceiveMessages(a,n)}}));try{(g_nativeAppPort=chrome.runtime.connectNative("com.apple.passwordmanager")).onMessage.addListener((async function(e){switch(JSON.stringify(e),chrome.storage.local.remove(["lastRetryTimestamp"]),cmd2string(e.cmd),e.cmd,e.cmd){case 9:case 10:resetTheSession(ContextState.CheckEngine),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){setToolbarIcon("PasswordsToolbarUnpaired")})),setGlobalState(ContextState.NotInSession,!0);break;case 2:switch(e.payload.QID,e.payload.QID){case"m0":thePAKE=e.payload.PAKE,setGlobalState(ContextState.MSG1Set);break;case"m2":try{g_secretSession.processMessage(e.payload.PAKE);setGlobalState(ContextState.SessionKeySet),thePAKE=null}catch(e){e.code,e.message,resetTheSession(ContextState.NotInSession)}}break;case 3:var t=RememberIC.UnknownPage;switch(e.payload,e.payload){case"DoNotRemember":t=RememberIC.DoNotRemember;break;case"RememberLoginAndPassword":t=RememberIC.RememberLoginAndPassword;break;case"UnknownPage":t=RememberIC.UnknownPage;break;case"NoValueSet":t=RememberIC.NoValueSet,STATUSErrorReturned(e.STATUS)}try{await chrome.tabs.sendMessage(e.tabId,{from:"background",subject:"RememberICSelection",tabId:e.tabId,frameId:e.frameId,theRememberICSelection:t,capabilities:g_nativeAppCapabilities},{frameId:e.frameId})}catch(t){e.tabId,e.frameId,t.message}break;case 4:t=RememberIC.UnknownPage;var s=[],a=[],n=[],r=e.payload,o=e.tabId,i=e.frameId,c=g_secretSession.parseSMSG(r.SMSG);switch((d=JSON.parse(c)).STATUS){case QueryStatus.Success:performance.now();var l=entriesFromLoginNames4URLData(d);l.sort(((e,t)=>e.USR.localeCompare(t.USR,void 0,{numeric:!0,sensitivity:"base"}))),l.forEach((e=>{if("Passwords not saved"===e.USR)t=RememberIC.DoNotRemember;else if(s.push(e.USR),a.push(e.CDate||e.ModDate),n.push(e.sites[0]),"Not Included"===e.PWD)t=RememberIC.RememberLoginAndPassword;else t=RememberIC.UnknownPage})),sendMessageToPopupAndCompletionList({from:"background",subject:"users",arrLoginNames:s,arrDates:a,arrHLDs:n,tabId:o,frameId:i,theRememberICSelection:t});break;case QueryStatus.NoResults:sendMessageToPopupAndCompletionList({from:"background",subject:"users",arrDates:[],tabId:o,frameId:i,arrLoginNames:[],arrHLDs:[],theRememberICSelection:RememberIC.UnknownPage});break;default:STATUSErrorReturned(d.STATUS)}break;case 5:var d;r=e.payload,c=g_secretSession.parseSMSG(r.SMSG);switch((d=JSON.parse(c)).STATUS){case QueryStatus.Success:{const t=e.url,s=entriesFromLoginNames4URLData(d).find((e=>e.sites.includes(t)));s&&sendUsernameAndPasswordToFrameForFilling(e.tabId,e.frameId,t,s.USR,s.PWD);break}case QueryStatus.NoResults:break;default:STATUSErrorReturned(d.STATUS)}break;case 16:handleGetOneTimeCodesCommand(e);break;case 8:case 7:case 6:break;case 14:g_nativeAppCapabilities=e.capabilities?e.capabilities:DefaultCapabilities,g_localizer=new Localizer(g_nativeAppCapabilities),g_tabMonitor.nativeAppSupportsQRCodeScanning=g_nativeAppCapabilities.scanForOTPURI,sendMessageToPopupAndCompletionList({subject:"hello",capabilities:g_nativeAppCapabilities}),resetTheSession(ContextState.NotInSession);break;case 15:handleOneTimeCodeAvailableCommand(e);break;case 17:handleDidFillOneTimeCodeCommand(e);break;case 18:{let e=g_secretSession.parseSMSG(r.SMSG),t=JSON.parse(e);if(JSON.stringify(t),t.STATUS===QueryStatus.Success);else STATUSErrorReturned(t.STATUS);break}default:cmd2string(e.cmd)}})),g_nativeAppPort.onDisconnect.addListener((e=>{const t=chrome.runtime.lastError;t.message,setTimeout((()=>{if(t.message,"Native host has exited."===t.message)chrome.storage.local.get(["lastRetryTimestamp"],(e=>{const t=e.lastRetryTimestamp;let s=!1;if(t){s=Date.now()-t>5e3}else s=!0;s?(chrome.storage.local.set({lastRetryTimestamp:Date.now()}),connectToBackgroundNativeAppAndSetUpListeners()):(chrome.storage.local.remove(["lastRetryTimestamp"]),resetTheSession(ContextState.NativeSupportNotInstalled))}));else t.message,resetTheSession(ContextState.NativeSupportNotInstalled)}),1e3)})),g_nativeAppPort.postMessage({cmd:14})}catch(e){resetTheSession(ContextState.NativeSupportNotInstalled)}}async function sendUsernameAndPasswordToFrameForFilling(t,s,a,n,r){try{await chrome.tabs.sendMessage(t,{from:"background",subject:"fillPassword",tabId:t,frameId:s,username:n,password:r,url:a},{frameId:s})}catch(t){e.message}}function handleOneTimeCodeAvailableCommand(e){getCurrentActiveTabAndFrame().then((e=>getOneTimeCodes(e[0],e[1],null))).catch((e=>{}))}function handleGetOneTimeCodesCommand(e){let t=null;try{t=JSON.parse(g_secretSession.parseSMSG(e.payload.SMSG))}catch(e){return}let s=t.STATUS;if(s!==QueryStatus.Success)return s!==QueryStatus.NoResults&&STATUSErrorReturned(s),void sendMessageToPopupAndCompletionList({from:"background",subject:"oneTimeCodes",oneTimeCodes:[]});let a=t.Entries;a&&sendMessageToPopupAndCompletionList({from:"background",subject:"oneTimeCodes",oneTimeCodes:a})}async function handleDidFillOneTimeCodeCommand(e){let t=null;try{t=JSON.parse(g_secretSession.parseSMSG(e.payload.SMSG))}catch(e){return}let s=t.STATUS;if(s!==QueryStatus.Success)return void(s!==QueryStatus.NoResults&&STATUSErrorReturned(s));let a=t.Entries;if(a&&a.length)try{await chrome.tabs.sendMessage(e.tabId,{subject:"fillCurrentTOTPCodeIntoForm",oneTimeCodes:a},{frameId:e.frameId})}catch(e){}}function CheckEstablishSession(){if(g_theState===ContextState.NotInSession)ChallengePIN()}function startiCloudControlPanel(){var e={cmd:11};JSON.stringify(e),g_nativeAppPort.postMessage(e)}function startPasswordsApp(){let e={cmd:13};JSON.stringify(e),g_nativeAppPort.postMessage(e)}function setUpTOTP(e,t){if(!g_nativeAppCapabilities.scanForOTPURI)return;const s={cmd:13,setUpTOTPPageURL:e,setUpTOTPURI:t};JSON.stringify(s),g_nativeAppPort.postMessage(s)}async function getUsernamesForMainFrameOfActiveTab(){if(g_theState!==ContextState.SessionKeySet)return;const e=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e.length)return;const t=e[0].id;GetLoginNames4URL(urlFromURLString((await chrome.webNavigation.getFrame({tabId:t,frameId:0})).url).hostname,t,0)}function GetLoginNames4URL(e,t,s){let a=JSON.stringify({ACT:actGhostSearch,URL:e}),n=g_secretSession.createSMSG(a),r={cmd:4,url:e,tabId:t,frameId:s,payload:JSON.stringify({QID:"CmdGetLoginNames4URL",SMSG:n})};g_timeStartedFetchingCredentials=performance.now(),g_nativeAppPort.postMessage(r)}function getOneTimeCodes(e,t,s){getAllParentFrameURLsOfFrame(e,t).then((a=>{let n={ACT:actGhostSearch,TYPE:"oneTimeCodes",frameURLs:a};s&&(n.username=s);let r=g_secretSession.createSMSG(n),o={cmd:16,tabId:e.id,frameId:t.frameId,payload:JSON.stringify({QID:"CmdGetOneTimeCodes",SMSG:r})};g_nativeAppPort.postMessage(o)})).catch((e=>{}))}function didFillOneTimeCode(e,t,s){if("totp"===e.source)getAllParentFrameURLsOfFrame(t,s).then((a=>{let n={ACT:actSearch,TYPE:"oneTimeCodes",frameURLs:a},r=e.username;r&&(n.username=r);let o=g_secretSession.createSMSG(n),i={cmd:17,tabId:t.id,frameId:s.frameId,payload:JSON.stringify({QID:"CmdDidFillOneTimeCode",SMSG:o})};g_nativeAppPort.postMessage(i)})).catch((e=>{}))}function openURLInSafari(e){g_nativeAppPort.postMessage({cmd:1984,url:e})}function getAllParentFrameURLsOfFrame(e,t){let s=e.id;return new Promise((a=>{-1!==t.parentFrameId?chrome.webNavigation.getFrame({tabId:s,frameId:t.parentFrameId},(s=>{getAllParentFrameURLsOfFrame(e,s).then((e=>{a([t.url].concat(e))})).catch((e=>{}))})):a([t.url])}))}function ChallengePIN(){if(g_theState===ContextState.NotInSession){var e={QID:"m0",PAKE:g_secretSession.initialMessage(),HSTBRSR:g_localizer.getMessage("browserName")},t={cmd:2,msg:JSON.stringify(e)};setGlobalState(ContextState.ChallengeSent);try{g_nativeAppPort.postMessage(t)}catch(e){e.message,resetTheSession(ContextState.NativeSupportNotInstalled)}}}function PINSet(e){g_secretSession.setPin(e);try{let e={QID:"m2",PAKE:g_secretSession.processMessage(thePAKE)},t={cmd:2,msg:JSON.stringify(e)};g_nativeAppPort.postMessage(t)}catch(e){e.code,e.message,resetTheSession(ContextState.NotInSession)}}function getCurrentActiveTabAndFrame(){return new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.webNavigation.getAllFrames({tabId:t[0].id},(function(s){e([t[0],s[0]])}))}))}))}function getCurrentActiveTabAndItsFrames(){return new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.webNavigation.getAllFrames({tabId:t[0].id},(function(s){e([t[0],s])}))}))}))}function canFillOneTimeCodes(){return(g_nativeAppCapabilities||DefaultCapabilities).canFillOneTimeCodes}function setUpPortToCompetionList(e){g_portToCompletionList=e,e.onMessage.addListener((async function(t){switch(JSON.stringify(t),t.subject){case"getContextAndMetadataFromContent":getCurrentActiveTabAndItsFrames().then((function(t){const s=t[0].id;for(const a of t[1]){const t=a.frameId;chrome.tabs.sendMessage(s,{from:"background",subject:"getContextAndMetadataForActiveTextField"},{frameId:t},(function(a){a&&e.postMessage({subject:"replyForGetContextAndMetadataFromContent",state:g_theState,tabId:s,frameId:t,url:a.url,textFieldMetadata:a.textFieldMetadata,formMetadata:a.formMetadata,presetUserName:a.presetUserName,hostname:a.hostname,canFillOneTimeCodes:canFillOneTimeCodes()})}))}})).catch((e=>{}));break;case"GetLoginNames4URL":GetLoginNames4URL(t.hostname,t.tabId,t.frameId);break;case"getOneTimeCodes":const s=t.tabId,a=t.frameId;chrome.webNavigation.getFrame({tabId:s,frameId:a},(e=>{e.frameId=a,getOneTimeCodes({id:t.tabId},e,t.username)}));break;case"openPasswordManagerAndDismissCompletionList":startPasswordsApp();try{await chrome.tabs.sendMessage(t.tabId,{subject:"dismissCompletionList"},{frameId:t.frameId})}catch(e){}break;case"openURLInSafari":openURLInSafari(t.url);break;case"resizeCompletionList":case"fillLoginIntoForm":case"fillOneTimeCodeIntoForm":case"dismissCompletionList":try{await chrome.tabs.sendMessage(t.tabId,t,{frameId:t.frameId})}catch(e){}}})),e.onDisconnect.addListener((e=>{e===g_portToCompletionList&&(g_portToCompletionList=null)})),sendMessageToCompletionList({subject:"hello",capabilities:g_nativeAppCapabilities})}function setUpPortToPopup(e){g_portToPopup=e,e.onMessage.addListener((function(t){switch(JSON.stringify(t),t.subject){case"getInitialPopupState":e.postMessage({subject:"nativeConnectionStateChanged",state:g_theState,appStoreURL:g_urlToDownloadNativeSupport});break;case"tryToEstablishNativeConnectionInResponseToUserActivatingPopup":chrome.storage.local.set({lastRetryTimestamp:Date.now()}),connectToBackgroundNativeAppAndSetUpListeners();break;case"challengePIN":ChallengePIN();break;case"userEnteredPIN":PINSet(t.pin);break;case"GetLoginNames4URL":GetLoginNames4URL(t.hostname,t.tabId,t.frameId);break;case"openPasswordManager":startPasswordsApp();break;case"startiCloudControlPanel":startiCloudControlPanel();break;case"SetUpTOTP":setUpTOTP(t.theURL,t.theTOTPURI);break;case"openURLInSafari":openURLInSafari(t.url)}})),e.onDisconnect.addListener((function(){g_theState===ContextState.MSG1Set&&PINSet(""),g_portToPopup=null})),sendMessageToPopup({subject:"hello",capabilities:g_nativeAppCapabilities})}chrome.storage.local.get("isDark",(function(e){void 0!==e.isDark&&(g_isDark=e.isDark),g_lastToolbarIconImageName&&setToolbarIcon(g_lastToolbarIconImageName)})),setUpEventListners(),checkForValidOS()?connectToBackgroundNativeAppAndSetUpListeners():(chrome.storage.local.get("hideUnsupportedOSPrompt",(function(e){e.hideUnsupportedOSPrompt||(chrome.storage.local.set({hideUnsupportedOSPrompt:1}),window.alert(g_localizer.getMessage("unsupportedOS")))})),setGlobalState(ContextState.IncompatibleOS)),chrome.windows.onFocusChanged.addListener((async e=>{if(!g_nativeAppPort||e===chrome.windows.WINDOW_ID_NONE)return;let t=await chrome.tabs.query({active:!0,currentWindow:!0});if(t.length<1)return;const s=t[0].id;if(!s)return;const a={cmd:8,tabId:s,event:1};JSON.stringify(a),g_nativeAppPort.postMessage(a)})),chrome.tabs.onActivated.addListener((e=>{if(JSON.stringify(e),!g_nativeAppPort)return;let t={cmd:8,tabId:e.tabId,event:1};JSON.stringify(t),g_nativeAppPort.postMessage(t)})),chrome.tabs.onRemoved.addListener(((e,t)=>{if(JSON.stringify(t),!g_nativeAppPort)return;let s={cmd:8,tabId:e,event:0};JSON.stringify(s),g_nativeAppPort.postMessage(s),g_TabsToStateMap.delete(e)})),chrome.runtime.onConnect.addListener((function(e){e.name,"completionList"===e.name?setUpPortToCompetionList(e):"popup"===e.name?setUpPortToPopup(e):e.name}));